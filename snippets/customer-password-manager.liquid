<div id="customer-password-manager" class="max-w-xl mx-auto p-6 bg-[#FCFBF7] rounded-lg shadow-md">
  <h2 class="text-2xl font-semibold text-[#514849] mb-4">Manage Your Password</h2>

  {% if customer %}
    <!-- Logged In: Verify Current Password & Redirect to Recover -->
    <form id="change-password-form" method="post" class="grid grid-cols-1 gap-4">
      <input type="hidden" name="form_type" value="customer_update">
      <input type="hidden" name="utf8" value="✓">

      <div>
        <label class="block text-[#514849] text-lg mb-2 font-medium">Current Password*</label>
        <input
          type="password"
          name="current_password"
          placeholder="Enter current password"
          class="w-full text-lg text-[#797375] placeholder:text-[#797375] border border-[#E3E2E0] py-3 px-4 rounded-lg"
          required
        >
      </div>

      <div>
        <button type="submit" class="btn !py-3 !px-6 bg-[#1E6C44] text-white rounded-lg">
          Verify & Set New Password
        </button>
      </div>
    </form>

    <script>
      document.addEventListener('DOMContentLoaded', function () {
        const form = document.getElementById('change-password-form');

        form.addEventListener('submit', function (e) {
          e.preventDefault();

          const password = form.current_password.value;

          // AJAX request to validate current password
          fetch('/account', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: `form_type=customer_login&utf8=✓&customer[email]={{ customer.email | url_encode }}&customer[password]=${encodeURIComponent(
              password
            )}`,
          })
            .then((res) => {
              if (res.status === 200 || res.redirected) {
                // Password correct → logout & redirect to recover
                window.location.href = '/account/logout?return_url=/account/recover';
              } else {
                alert('Current password is incorrect.');
              }
            })
            .catch((err) => {
              alert('Something went wrong. Try again.');
              console.error(err);
            });
        });
      });
    </script>

  {% else %}
    <!-- Logged Out: Send Reset Link Form -->
    <p class="text-base text-[#797375] mb-4">Forgot your password? Enter your email below to receive a reset link.</p>
    <form id="recover-password-form" method="post" action="/account/recover" class="grid grid-cols-1 gap-4">
      <input type="hidden" name="form_type" value="recover_customer_password">
      <input type="hidden" name="utf8" value="✓">

      <div>
        <label for="customer-email" class="block text-[#514849] text-lg mb-2 font-medium">Email*</label>
        <input
          id="customer-email"
          name="email"
          type="email"
          placeholder="Enter your email"
          class="w-full text-lg text-[#797375] placeholder:text-[#797375] border border-[#E3E2E0] py-3 px-4 rounded-lg"
          required
        >
      </div>

      <div>
        <button type="submit" class="btn !py-3 !px-6 bg-[#1E6C44] text-white rounded-lg">Send Reset Link</button>
      </div>
    </form>
  {% endif %}
</div>
